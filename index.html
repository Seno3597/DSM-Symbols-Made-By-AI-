<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DSModding Symbols</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --sand:#f6e7d7;
      --sea:#2db7c5;
      --deep-sea:#045d6b;
      --palm:#2fa34a;
      --accent:#ff6fa3; /* soft magenta */
      --card:#ffffff11;
      --glass: rgba(255,255,255,0.04);
      --muted:#cbd5d9;
      --text:#eaf6f5;
      --radius:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter, 'Segoe UI', system-ui, -apple-system, Roboto, 'Helvetica Neue';
      background: linear-gradient(180deg, #072023 0%, #073339 40%, #0b2a2a 100%);
      color:var(--text);-webkit-font-smoothing:antialiased;
      padding:28px;
    }

    .app{
      max-width:1200px;margin:0 auto;display:grid;grid-template-columns:380px 1fr;gap:28px;align-items:start;
    }

    /* SIDEBAR / BRAND */
    .brand-card{
      background: linear-gradient(135deg, rgba(47,163,74,0.08), rgba(45,183,197,0.06));
      border:1px solid rgba(255,255,255,0.04);padding:22px;border-radius:var(--radius);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 30px rgba(2,18,18,0.6);
    }

    .logo{
      display:flex;gap:12px;align-items:center
    }
    .logo .icon{
      width:62px;height:62px;border-radius:12px;background:linear-gradient(135deg,var(--palm),var(--sea));
      display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 6px 18px rgba(45,183,197,0.12);
    }
    .logo h1{font-size:20px;margin:0;line-height:1;color:var(--sand)}
    .logo p{margin:6px 0 0;color:var(--muted);font-size:13px}

    /* admin box */
    .admin-box{margin-top:18px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .admin-box .title{color:var(--sand);font-weight:700;margin-bottom:8px}
    .pwd-row{display:flex;gap:10px}
    .pwd-row input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.05);background:transparent;color:var(--text)}
    .pwd-row button{padding:12px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--sea),var(--palm));color:#022;cursor:pointer;font-weight:700}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}

    /* upload panel */
    .panel{
      grid-column:1/-1;padding:18px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow: 0 10px 40px rgba(2,12,12,0.6);
    }

    .upload-area{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;border-radius:12px;border:2px dashed rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);cursor:pointer;transition:all .18s}
    .upload-area:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,12,12,0.6)}
    .upload-area.dragover{border-color:rgba(47,163,74,0.8);background:linear-gradient(180deg, rgba(47,163,74,0.02), transparent)}
    .upload-icon{font-size:44px;margin-bottom:10px}
    .upload-text{color:var(--sand);font-weight:800}
    .upload-sub{color:var(--muted);margin-top:6px}

    .row{display:flex;gap:12px;margin-top:12px}
    .row .input{flex:1}
    input[type=text]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .primary-btn{padding:12px 18px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--palm),var(--sea));color:#012;font-weight:800;cursor:pointer}
    .primary-btn:disabled{opacity:.5;cursor:not-allowed}

    /* right column content */
    .content{padding:18px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);box-shadow: 0 8px 30px rgba(0,0,0,0.6);transition:all .18s}
    .card:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(2,12,12,0.7)}
    .card .title{font-weight:800;color:var(--deep-sea)}
    .meta{color:var(--muted);margin-top:6px}
    .tag{display:inline-block;background:linear-gradient(90deg,var(--sand),rgba(255,255,255,0.06));color:#082;padding:6px 10px;border-radius:999px;font-weight:800;margin-top:10px}
    .actions{display:flex;gap:8px;margin-top:12px}
    .action-btn{flex:1;padding:10px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
    .download{background:linear-gradient(90deg,var(--sea),#33c5b6);color:#022}
    .edit{background:linear-gradient(90deg,var(--palm),#7ee08a);color:#022}
    .del{background:linear-gradient(90deg,#ff8b8b,#ff6f6f);color:#210}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,6,6,0.6),rgba(2,6,6,0.85));z-index:9999}
    .modal.show{display:flex}
    .modal-panel{width:520px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:14px;border:1px solid rgba(255,255,255,0.03)}

    /* footer small */
    .foot{margin-top:14px;color:var(--muted);font-size:13px}

    /* responsive */
    @media (max-width:980px){.app{grid-template-columns:1fr;}.panel{order:2}.brand-card{order:1}}

  </style>
</head>
<body>
  <div class="app">
    <div class="brand-card">
      <div class="logo">
        <div class="icon">üå¥</div>
        <div>
          <h1>DSModding Symbols</h1>
          <p>Shared IL2CPP symbol files ‚Äî tropical edition</p>
        </div>
      </div>

      <div class="admin-box">
        <div class="title">Admin Access</div>
        <div class="hint">Admins can upload, edit &amp; delete. Non-admins can still download.</div>
        <div style="height:12px"></div>
        <div class="pwd-row">
          <input id="passwordInput" type="password" placeholder="Enter admin password" aria-label="admin password">
          <button id="unlockBtn">Unlock</button>
        </div>
        <div id="adminStatus" class="hint">Status: <strong id="statusText">Locked</strong></div>
      </div>

      <div style="height:18px"></div>
      <div class="foot">Tip: Upload only .json symbol files. Files are shared for all users until removed by admins.</div>
    </div>

    <div>
      <div class="panel">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
          <div>
            <div style="font-weight:800;font-size:18px;color:var(--sand)">Upload Symbol (Admins)</div>
            <div style="color:var(--muted);font-size:13px;margin-top:6px">Only .json files are allowed. Files uploaded are visible to everyone.</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="refreshBtn" class="primary-btn">Refresh</button>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">Drop your .json symbol file here</div>
          <div class="upload-sub">or click to browse</div>
          <input id="fileInput" type="file" accept=".json" style="display:none" />
        </div>

        <div class="row">
          <div class="input">
            <label style="color:var(--muted);font-weight:700">Symbol Name</label>
            <input id="symbolName" type="text" placeholder="A friendly name (e.g. GameX v1.2 symbols)" />
          </div>
          <div style="width:150px;display:flex;align-items:end">
            <button id="uploadBtn" class="primary-btn" disabled>Upload</button>
          </div>
        </div>
      </div>

      <div class="content" style="margin-top:18px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900;font-size:18px;color:var(--sand)">Available Symbol Files</div>
          <div style="color:var(--muted);font-size:13px">Shared to all users ‚Ä¢ Admins can delete</div>
        </div>

        <div style="height:12px"></div>
        <div class="grid" id="symbolsGrid">
          <div class="card"><div style="font-weight:800;color:var(--muted)">Loading‚Ä¶</div></div>
        </div>
      </div>
    </div>

  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">Edit Symbol</div>
        <button id="closeEditBtn" style="background:none;border:0;color:var(--muted);font-size:18px">‚úï</button>
      </div>

      <div style="height:10px"></div>
      <div>
        <label style="color:var(--muted);font-weight:800">Symbol Name</label>
        <input id="editSymbolName" type="text" style="width:100%;padding:10px;margin-top:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text)" />
      </div>

      <div style="height:10px"></div>
      <div>
        <label style="color:var(--muted);font-weight:800">Replace File (optional)</label>
        <div class="upload-area" id="editUploadArea" style="padding:10px;cursor:pointer">
          <div class="upload-text" style="font-size:14px">Click to select new .json</div>
          <input id="editFileInput" type="file" accept=".json" style="display:none" />
        </div>
      </div>

      <div style="height:12px"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="cancelEditBtn" class="primary-btn" style="background:linear-gradient(90deg,#ddd,#ccc);color:#012">Cancel</button>
        <button id="saveEditBtn" class="primary-btn">Save</button>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG (already filled) ===== */
const SUPABASE_URL = "https://soymukwehosfwavafrxd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNveW11a3dlaG9zZndhdmFmcnhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMjU4NTksImV4cCI6MjA3OTkwMTg1OX0.vRpR3LVCKVHaxo-ORPE93QJP_-P3aYh9zCu3STa5qdc";
const ADMIN_PASSWORD = "SenoCoolioSeno";
/* =================================== */

// initialize supabase after DOM loaded
let supabase;

// app state
let isAdmin = false;
let selectedFile = null;
let editingId = null;
let editingNewFile = null;
let symbolsCache = {};


function $(id){return document.getElementById(id)}

function showStatus(text){ $('statusText').textContent = text }

function sanitizeFileName(n){return n.replace(/[^a-zA-Z0-9._-]/g,'_')}
function formatSize(b){ if(!b) return '0 Bytes'; if(b<1024) return b+' B'; if(b<1048576) return (b/1024).toFixed(2)+' KB'; return (b/1048576).toFixed(2)+' MB'}

// wait for DOM
window.addEventListener('DOMContentLoaded', async ()=>{
  // create supabase client
  try { supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } catch(e){ console.error('supabase init err', e) }

  // wire up elements
  const unlockBtn = $('unlockBtn');
  const passwordInput = $('passwordInput');
  const uploadArea = $('uploadArea');
  const fileInput = $('fileInput');
  const uploadBtn = $('uploadBtn');
  const symbolName = $('symbolName');
  const refreshBtn = $('refreshBtn');
  const symbolsGrid = $('symbolsGrid');

  // admin unlock handler (fixed)
  unlockBtn.addEventListener('click', ()=>{
    const v = passwordInput.value || '';
    if(v === ADMIN_PASSWORD){
      isAdmin = true;
      showStatus('Admin');
      alert('Admin unlocked. You can now upload / edit / delete.');
    } else {
      showStatus('Locked');
      alert('Incorrect password');
    }
  });

  passwordInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') unlockBtn.click(); });

  // file select
  uploadArea.addEventListener('click', ()=> fileInput.click());
  uploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); uploadArea.classList.add('dragover') })
  uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('dragover'))
  uploadArea.addEventListener('drop', (e)=>{ e.preventDefault(); uploadArea.classList.remove('dragover'); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]) })

  fileInput.addEventListener('change', (e)=> { if(e.target.files.length) handleFile(e.target.files[0]) })

  function handleFile(f){
    if(!f.name.toLowerCase().endsWith('.json') && f.type !== 'application/json'){
      alert('Only .json files allowed'); fileInput.value=''; return;
    }
    selectedFile = f; uploadArea.querySelector('.upload-text').textContent = 'Selected: '+f.name; uploadArea.querySelector('.upload-sub').textContent = 'Size: '+formatSize(f.size);
    checkReady();
  }

  function checkReady(){ uploadBtn.disabled = !(selectedFile && symbolName.value.trim()) }
  symbolName.addEventListener('input', checkReady);

  uploadBtn.addEventListener('click', async ()=>{
    if(!isAdmin) return alert('Admin only');
    if(!selectedFile || !symbolName.value.trim()) return;
    uploadBtn.disabled = true; uploadBtn.textContent = 'Uploading‚Ä¶'
    try{
      const path = `${Date.now()}_${sanitizeFileName(selectedFile.name)}`;
      const { data: up, error: upErr } = await supabase.storage.from('symbols').upload(path, selectedFile, { cacheControl: '3600', contentType: 'application/json' });
      if(upErr) throw upErr;
      const { data: ins, error: insErr } = await supabase.from('symbols').insert([{ name: symbolName.value.trim(), filename: selectedFile.name, size: selectedFile.size, storage_path: path }]).select().single();
      if(insErr) {
        await supabase.storage.from('symbols').remove([path]).catch(()=>{});
        throw insErr;
      }
      selectedFile = null; symbolName.value = ''; fileInput.value = ''; uploadArea.querySelector('.upload-text').textContent='Drop your .json symbol file here'; uploadArea.querySelector('.upload-sub').textContent='or click to browse';
      await loadSymbols();
      alert('Uploaded and visible to everyone.');
    }catch(err){ console.error(err); alert('Upload failed: '+(err.message||JSON.stringify(err))) }
    finally{ uploadBtn.disabled = false; uploadBtn.textContent = 'Upload' }
  });

  refreshBtn.addEventListener('click', ()=> loadSymbols());

  // edit modal wiring
  $('editUploadArea').addEventListener('click', ()=> $('editFileInput').click());
  $('editFileInput').addEventListener('change', (e)=>{ if(e.target.files.length) { editingNewFile = e.target.files[0]; $('editUploadArea').querySelector('.upload-text').textContent = 'Selected: '+editingNewFile.name }});
  $('closeEditBtn').addEventListener('click', closeEditModal);
  $('cancelEditBtn').addEventListener('click', closeEditModal);
  $('saveEditBtn').addEventListener('click', saveEdit);

  // initial load
  await loadSymbols();

}); // DOMContentLoaded end


/* ====== loadSymbols ====== */
async function loadSymbols(){
  const grid = $('symbolsGrid');
  grid.innerHTML = `<div class="card"><div style="font-weight:800;color:var(--muted)">Loading‚Ä¶</div></div>`;
  try{
    const { data, error } = await supabase.from('symbols').select('*').order('created_at',{ascending:false});
    if(error) throw error;
    if(!data || data.length===0){ grid.innerHTML = `<div class="card"><div style="font-weight:800;color:var(--muted)">No symbol files</div></div>`; symbolsCache = {}; return }

    symbolsCache = {};
    const nodes = data.map(r=>{
      symbolsCache[r.id]=r;
      return renderCard(r);
    });
    grid.innerHTML = nodes.join('');
  }catch(e){ console.error(e); grid.innerHTML = `<div class="card"><div style="font-weight:800;color:var(--muted)">Error loading (see console)</div></div>` }
}

function renderCard(row){
  const id = row.id;
  const created = new Date(row.created_at).toLocaleString();
  return `
    <div class="card" id="card-${id}">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="title">${escapeHtml(row.name)}</div>
        <div style="font-size:12px;color:var(--muted)">${created}</div>
      </div>
      <div class="meta">${escapeHtml(row.filename)}</div>
      <div class="tag">${formatSize(row.size)}</div>
      <div class="actions">
        <button class="action-btn download" onclick="downloadSymbol('${id}')">Download</button>
        <button class="action-btn edit" onclick="openEditModal('${id}')">Edit</button>
        <button class="action-btn del" onclick="deleteSymbol('${id}')">Delete</button>
      </div>
    </div>
  `;
}

/* ====== download ====== */
async function downloadSymbol(id){
  const row = symbolsCache[id]; if(!row) return alert('Missing');
  const { data: urlData, error } = supabase.storage.from('symbols').getPublicUrl(row.storage_path);
  if(error) { console.error(error); return alert('URL error') }
  const url = urlData?.publicUrl || urlData?.public_url || '';
  if(!url) return alert('No URL');
  const a = document.createElement('a'); a.href = url; a.download = row.filename; document.body.appendChild(a); a.click(); a.remove();
}

/* ====== delete ====== */
async function deleteSymbol(id){
  if(!isAdmin) return alert('Admin only');
  if(!confirm('Delete permanently?')) return;
  try{
    const row = symbolsCache[id]; if(!row) throw new Error('Missing');
    await supabase.storage.from('symbols').remove([row.storage_path]);
    await supabase.from('symbols').delete().eq('id', id);
    document.getElementById('card-'+id)?.remove(); delete symbolsCache[id];
  }catch(e){ console.error(e); alert('Delete failed') }
}

/* ====== edit modal ====== */
function openEditModal(id){
  if(!isAdmin) return alert('Admin only');
  const row = symbolsCache[id]; if(!row) return alert('Missing');
  editingId = id; $('editSymbolName').value = row.name || ''; $('editUploadArea').querySelector('.upload-text').textContent = 'Click to select new .json'; editingNewFile = null; $('editModal').classList.add('show');
}
function closeEditModal(){ editingId = null; editingNewFile = null; $('editModal').classList.remove('show'); }

async function saveEdit(){
  if(!isAdmin) return alert('Admin only');
  if(!editingId) return;
  const newName = $('editSymbolName').value.trim(); if(!newName) return alert('Enter a name');
  try{
    const row = symbolsCache[editingId]; if(!row) throw new Error('Missing');
    let storagePath = row.storage_path; let filename = row.filename; let size = row.size;
    if(editingNewFile){
      const newPath = `${Date.now()}_${sanitizeFileName(editingNewFile.name)}`;
      const { error: upErr } = await supabase.storage.from('symbols').upload(newPath, editingNewFile, { contentType:'application/json' });
      if(upErr) throw upErr;
      await supabase.storage.from('symbols').remove([row.storage_path]).catch(()=>{});
      storagePath = newPath; filename = editingNewFile.name; size = editingNewFile.size;
    }
    const { error } = await supabase.from('symbols').update({ name:newName, filename, size, storage_path: storagePath }).eq('id', editingId);
    if(error) throw error;
    await loadSymbols(); closeEditModal(); alert('Updated');
  }catch(e){ console.error(e); alert('Update failed') }
}

// wire edit file input
$('editFileInput')?.addEventListener('change', (e)=>{ if(e.target.files.length) { editingNewFile = e.target.files[0]; $('editUploadArea').querySelector('.upload-text').textContent = 'Selected: '+editingNewFile.name } });

/* ===== utils ===== */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])) }

</script>
</body>
</html>
