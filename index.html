<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DSModding Symbols</title>

  <!-- Supabase JS (v2 compatible build) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --purple:#a64bff;
      --purple-dark:#6a20c7;
      --lime:#8aff00;
      --magenta:#ff2dcf;
      --cyan:#17e8ff;
      --bg-dark:#0b0b0b;
      --bg-card:#161616;
      --bg-panel:#1e1e1e;
      --text-light:#e8e8e8;
      --text-muted:#999;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg-dark);color:var(--text-light);font-family:Segoe UI,Arial;min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{text-align:center;margin-bottom:30px}
    .header h1{font-size:2.6rem;background:linear-gradient(135deg,var(--purple),var(--cyan),var(--magenta));-webkit-background-clip:text;color:transparent}
    .header p{color:var(--text-muted);margin-top:6px}

    .admin-section{background:var(--bg-panel);border:1px solid var(--purple);border-radius:12px;padding:18px;margin-bottom:18px;box-shadow:0 0 12px #a64bff33}
    .admin-lock{display:flex;gap:12px;align-items:center}
    .admin-lock-icon{font-size:1.6rem}
    .admin-lock-title{color:var(--lime);font-weight:700}
    .password-group{display:flex;gap:10px;margin-top:12px}
    .password-group input{flex:1;padding:10px;border-radius:8px;background:#121212;border:1px solid var(--purple);color:var(--text-light)}
    .password-group button{padding:10px 18px;border-radius:8px;border:0;background:linear-gradient(135deg,var(--lime),var(--cyan));font-weight:700;cursor:pointer}

    .upload-section{background:var(--bg-panel);border:1px solid var(--purple);border-radius:12px;padding:18px;margin-bottom:18px;display:none;box-shadow:0 0 12px #a64bff33}
    .upload-section.active{display:block}
    .upload-area{padding:30px;border-radius:12px;border:2px dashed var(--magenta);background:#141414;text-align:center;cursor:pointer;transition:all .15s}
    .upload-area:hover{border-color:var(--cyan);background:#1b1b1b}
    .upload-area.dragover{border-color:var(--lime);background:#222}
    .upload-text{color:var(--lime);font-weight:700;margin-bottom:6px}
    .upload-subtext{color:var(--text-muted);font-size:.95rem}

    .input-group{margin-top:14px}
    .input-group label{display:block;color:var(--magenta);font-weight:700;margin-bottom:6px}
    .input-group input[type="text"]{width:100%;padding:10px;border-radius:8px;background:#141414;border:1px solid var(--purple);color:var(--text-light)}

    .btn{margin-top:12px;padding:12px 22px;border-radius:10px;border:0;background:linear-gradient(135deg,var(--purple),var(--cyan));font-weight:800;cursor:pointer;color:#030303}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .symbols-section{margin-top:10px}
    .section-title{font-size:1.6rem;margin-bottom:12px}
    .symbols-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .symbol-card{background:var(--bg-card);border-radius:12px;padding:14px;border:1px solid var(--purple-dark);box-shadow:0 0 10px #6a20c720;transition:all .15s}
    .symbol-card:hover{transform:translateY(-6px);border-color:var(--magenta);box-shadow:0 0 18px #ff2dcf44}
    .symbol-header{display:flex;justify-content:space-between;align-items:center}
    .symbol-name{font-size:1.05rem;color:var(--cyan);font-weight:800}
    .symbol-info{color:var(--text-muted);margin-top:8px}
    .symbol-size{display:inline-block;background:#222;padding:6px 10px;border-radius:20px;color:var(--lime);font-weight:700;margin-top:8px}
    .symbol-actions{display:flex;gap:8px;margin-top:12px}
    .btn-small{flex:1;padding:8px;border-radius:8px;border:0;font-weight:800;cursor:pointer}
    .btn-download{background:linear-gradient(135deg,var(--cyan),var(--lime));color:#040404}
    .btn-edit{background:var(--magenta);color:#020202}
    .btn-delete{background:#ff3e3e;color:#fff}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);align-items:center;justify-content:center;z-index:1000}
    .modal.active{display:flex}
    .modal-content{background:var(--bg-card);border-radius:12px;padding:18px;border:1px solid var(--purple);width:min(560px,96%);box-shadow:0 0 18px #a64bff33}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal-title{color:var(--magenta);font-weight:800}
    .modal-close{background:none;border:0;color:var(--text-muted);font-size:1.25rem;cursor:pointer}
    .modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    .empty-state{text-align:center;padding:30px;color:var(--text-muted)}
    .error-message{background:#ff444420;border:1px solid #ff4444;color:#ff7b7b;padding:8px;border-radius:8px;margin-top:8px}

    @media (max-width:600px){ .symbol-name{font-size:1rem} .header h1{font-size:1.6rem} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>DSModding Symbols</h1>
      <p>IL2CPP Symbol File Repository ‚Äî shared via Supabase</p>
    </div>

    <!-- Admin login -->
    <div class="admin-section" id="adminSection">
      <div class="admin-lock">
        <div class="admin-lock-icon">üîí</div>
        <div>
          <div class="admin-lock-title">Admin Access Required</div>
          <div class="admin-lock-desc">Enter password to manage symbol uploads (admins only)</div>
        </div>
      </div>

      <div class="password-group">
        <input id="passwordInput" type="password" placeholder="Enter admin password" />
        <button id="unlockBtn">Unlock</button>
      </div>

      <div id="errorMessage"></div>
    </div>

    <!-- Upload / manage -->
    <div class="upload-section" id="uploadSection">
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <div class="upload-text">Drop your JSON symbol file here</div>
        <div class="upload-subtext">or click to browse ‚Äî only <strong>.json</strong> allowed</div>
        <input id="fileInput" type="file" accept=".json" style="display:none" />
      </div>

      <div class="input-group">
        <label for="symbolName">Symbol Name</label>
        <input id="symbolName" type="text" placeholder="Enter a name for this symbol file" />
      </div>

      <button id="uploadBtn" class="btn" disabled>Upload Symbol File (JSON)</button>
    </div>

    <!-- Symbols list -->
    <div class="symbols-section">
      <h2 class="section-title">Available Symbol Files</h2>
      <div class="symbols-grid" id="symbolsGrid">
        <div class="empty-state">
          <div class="empty-state-icon">üì¶</div>
          <div class="empty-state-text">No symbol files available</div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit Symbol File</h3>
          <button class="modal-close" id="editCloseBtn">√ó</button>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <label for="editSymbolName">Symbol Name</label>
            <input id="editSymbolName" type="text" />
          </div>
          <div class="input-group" style="margin-top:12px">
            <label>Current File</label>
            <div class="symbol-info" id="editCurrentFile"></div>
          </div>

          <div class="input-group" style="margin-top:12px">
            <label for="editFileInput">Replace File (optional ‚Äî .json only)</label>
            <div class="upload-area" id="editUploadArea" style="padding:12px;cursor:pointer">
              <div class="upload-text" style="font-size:0.95rem">Click to select new file</div>
              <input id="editFileInput" type="file" accept=".json" style="display:none" />
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" id="editCancelBtn">Cancel</button>
          <button class="btn btn-primary" id="editSaveBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG: paste your Supabase values here ======
   Get them from Project Settings -> API in Supabase dashboard */
const SUPABASE_URL = "https://soymukwehosfwavafrxd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNveW11a3dlaG9zZndhdmFmcnhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMjU4NTksImV4cCI6MjA3OTkwMTg1OX0.vRpR3LVCKVHaxo-ORPE93QJP_-P3aYh9zCu3STa5qdc";
/* ===================================================== */

/* Admin password (kept as requested) */
const ADMIN_PASSWORD = "SenoCoolioSeno";

/* Initialize Supabase client */
const supabase = supabaseJs.createClient
  ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) // older loader name
  : supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* App state */
let isAdmin = false;
let selectedFile = null;
let editingSymbolId = null;
let editingNewFile = null;
let symbols = {}; // cached metadata keyed by id

/* DOM */
const adminSection = document.getElementById("adminSection");
const uploadSection = document.getElementById("uploadSection");
const passwordInput = document.getElementById("passwordInput");
const unlockBtn = document.getElementById("unlockBtn");
const errorMessage = document.getElementById("errorMessage");

const uploadArea = document.getElementById("uploadArea");
const fileInput = document.getElementById("fileInput");
const symbolName = document.getElementById("symbolName");
const uploadBtn = document.getElementById("uploadBtn");

const symbolsGrid = document.getElementById("symbolsGrid");

const editModal = document.getElementById("editModal");
const editCloseBtn = document.getElementById("editCloseBtn");
const editCancelBtn = document.getElementById("editCancelBtn");
const editSaveBtn = document.getElementById("editSaveBtn");
const editSymbolName = document.getElementById("editSymbolName");
const editCurrentFile = document.getElementById("editCurrentFile");
const editFileInput = document.getElementById("editFileInput");
const editUploadArea = document.getElementById("editUploadArea");

/* ======= Admin unlock ======= */
unlockBtn.addEventListener("click", () => {
  const pwd = passwordInput.value || "";
  if (pwd === ADMIN_PASSWORD) {
    isAdmin = true;
    adminSection.style.display = "none";
    uploadSection.classList.add("active");
    document.body.classList.add("admin-mode");
    errorMessage.innerHTML = "";
  } else {
    errorMessage.innerHTML = '<div class="error-message">‚ùå Incorrect password</div>';
    passwordInput.value = "";
  }
});

passwordInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") unlockBtn.click();
});

/* ======= File select UI ======= */
uploadArea.addEventListener("click", () => fileInput.click());
uploadArea.addEventListener("dragover", (e) => { e.preventDefault(); uploadArea.classList.add("dragover"); });
uploadArea.addEventListener("dragleave", () => uploadArea.classList.remove("dragover"));
uploadArea.addEventListener("drop", (e) => {
  e.preventDefault();
  uploadArea.classList.remove("dragover");
  if (!e.dataTransfer || !e.dataTransfer.files || e.dataTransfer.files.length === 0) return;
  handleFileSelect(e.dataTransfer.files[0]);
});

fileInput.addEventListener("change", (e) => {
  if (e.target.files.length) handleFileSelect(e.target.files[0]);
});

function handleFileSelect(file) {
  // accept only json by extension and type
  if (!file.name.toLowerCase().endsWith(".json") && file.type !== "application/json") {
    alert("Only .json files are allowed.");
    fileInput.value = "";
    return;
  }
  selectedFile = file;
  uploadArea.querySelector(".upload-text").textContent = `Selected: ${file.name}`;
  uploadArea.querySelector(".upload-subtext").textContent = `Size: ${formatFileSize(file.size)}`;
  checkUploadReady();
}

symbolName.addEventListener("input", checkUploadReady);
function checkUploadReady() {
  uploadBtn.disabled = !(selectedFile && symbolName.value.trim());
}

/* ======= Upload flow (admin only) ======= */
uploadBtn.addEventListener("click", async () => {
  if (!isAdmin) return alert("You must be an admin to upload.");
  if (!selectedFile || !symbolName.value.trim()) return;

  uploadBtn.disabled = true;
  uploadBtn.textContent = "Uploading‚Ä¶";

  try {
    // create a unique path to avoid collisions
    const path = `${Date.now()}_${sanitizeFileName(selectedFile.name)}`;

    // upload to Supabase storage
    const { data: upData, error: upError } = await supabase.storage
      .from("symbols")
      .upload(path, selectedFile, { cacheControl: "3600", contentType: "application/json", upsert: false });

    if (upError) throw upError;

    // insert metadata into table
    const { data: insertData, error: insertError } = await supabase
      .from("symbols")
      .insert([{
        name: symbolName.value.trim(),
        filename: selectedFile.name,
        size: selectedFile.size,
        storage_path: path
      }])
      .select()
      .single();

    if (insertError) {
      // try to cleanup uploaded file if DB insert failed
      await supabase.storage.from("symbols").remove([path]).catch(()=>{});
      throw insertError;
    }

    // refresh list
    await loadSymbols();

    // reset UI
    selectedFile = null;
    symbolName.value = "";
    fileInput.value = "";
    uploadArea.querySelector('.upload-text').textContent = 'Drop your JSON symbol file here';
    uploadArea.querySelector('.upload-subtext').textContent = 'or click to browse';
    alert("Upload successful ‚Äî available to everyone.");
  } catch (err) {
    console.error(err);
    alert("Upload failed: " + (err.message || JSON.stringify(err)));
  } finally {
    uploadBtn.disabled = false;
    uploadBtn.textContent = "Upload Symbol File (JSON)";
  }
});

/* ======= Load symbols from database ======= */
async function loadSymbols() {
  symbolsGrid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚è≥</div><div class="empty-state-text">Loading‚Ä¶</div></div>`;

  const { data, error } = await supabase
    .from("symbols")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error("DB read error", error);
    symbolsGrid.innerHTML = `<div class="empty-state">Error loading symbols ‚Äî check console</div>`;
    return;
  }

  if (!data || data.length === 0) {
    symbolsGrid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-text">No symbol files available</div></div>`;
    symbols = {};
    return;
  }

  // build the grid
  symbols = {};
  const nodes = await Promise.all(data.map(async (row) => {
    symbols[row.id] = row;
    let publicUrl = "";
    try {
      // get public URL for storage path
      const { data: urlData } = supabase.storage.from("symbols").getPublicUrl(row.storage_path);
      publicUrl = (urlData && (urlData.publicUrl || urlData.public_url)) || "";
    } catch (e) {
      publicUrl = "";
    }

    return renderSymbolCard(row, publicUrl);
  }));

  symbolsGrid.innerHTML = nodes.join("");
}

/* ======= Render one card (returns HTML string) ======= */
function renderSymbolCard(row, publicUrl) {
  // store link in the row for easy download
  const downloadOnClick = `downloadSymbol('${row.id}')`;
  const editOnClick = `openEditModal('${row.id}')`;
  const deleteOnClick = `deleteSymbol('${row.id}')`;

  return `
    <div class="symbol-card" id="symbol-${row.id}">
      <div class="symbol-header">
        <div class="symbol-name">${escapeHtml(row.name)}</div>
        <div style="font-size:.85rem;color:${'var(--text-muted)'}">${new Date(row.created_at).toLocaleString()}</div>
      </div>

      <div class="symbol-info">${escapeHtml(row.filename)}</div>
      <div class="symbol-size">${formatFileSize(row.size)}</div>

      <div class="symbol-actions">
        <button class="btn-small btn-download" onclick="${downloadOnClick}">Download</button>
        <button class="btn-small btn-edit" onclick="${editOnClick}">Edit</button>
        <button class="btn-small btn-delete" onclick="${deleteOnClick}">Delete</button>
      </div>
    </div>
  `;
}

/* ======= Download: fetch public URL from storage and open ======= */
async function downloadSymbol(id) {
  const row = symbols[id];
  if (!row) return alert("Symbol not found.");

  // get public url (should be public by default)
  const { data: urlData, error: urlError } = supabase.storage.from("symbols").getPublicUrl(row.storage_path);
  if (urlError || !urlData) {
    console.error("getPublicUrl error", urlError);
    return alert("Unable to get file URL.");
  }

  const url = urlData.publicUrl || urlData.public_url || "";
  if (!url) return alert("File URL unavailable.");

  // trigger download by navigating to the URL
  const a = document.createElement("a");
  a.href = url;
  a.download = row.filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ======= Delete (admin only) ======= */
async function deleteSymbol(id) {
  if (!isAdmin) return alert("You must be an admin to delete.");
  if (!confirm("Are you sure you want to permanently delete this symbol?")) return;

  try {
    const row = symbols[id];
    if (!row) return alert("Symbol not found.");

    // remove from storage
    await supabase.storage.from("symbols").remove([row.storage_path]);

    // remove from DB
    await supabase.from("symbols").delete().eq("id", id);

    // UI
    delete symbols[id];
    document.getElementById(`symbol-${id}`)?.remove();
  } catch (err) {
    console.error(err);
    alert("Delete failed: " + (err.message || JSON.stringify(err)));
  }
}

/* ======= Edit modal ======= */
function openEditModal(id) {
  if (!isAdmin) return alert("You must be an admin to edit.");
  editingSymbolId = id;
  const row = symbols[id];
  if (!row) return alert("Symbol not found.");

  editSymbolName.value = row.name || "";
  editCurrentFile.textContent = `${row.filename} (${formatFileSize(row.size)})`;
  editingNewFile = null;
  editFileInput.value = "";
  editUploadArea.querySelector(".upload-text").textContent = "Click to select new file";
  editModal.classList.add("active");
}

editCloseBtn.addEventListener("click", closeEditModal);
editCancelBtn.addEventListener("click", closeEditModal);
function closeEditModal() {
  editModal.classList.remove("active");
  editingSymbolId = null;
  editingNewFile = null;
}

/* handle replace file selection */
editUploadArea.addEventListener("click", () => editFileInput.click());
editFileInput.addEventListener("change", (e) => {
  if (!e.target.files || e.target.files.length === 0) return;
  const f = e.target.files[0];
  if (!f.name.toLowerCase().endsWith(".json") && f.type !== "application/json") {
    alert("Only .json files are allowed.");
    editFileInput.value = "";
    return;
  }
  editingNewFile = f;
  editUploadArea.querySelector(".upload-text").textContent = `Selected: ${f.name}`;
});

/* save edit */
editSaveBtn.addEventListener("click", async () => {
  if (!isAdmin) return alert("You must be an admin to edit.");
  if (!editingSymbolId) return;

  const newName = editSymbolName.value.trim();
  if (!newName) return alert("Please enter a name.");

  try {
    const row = symbols[editingSymbolId];
    if (!row) throw new Error("Row missing.");

    // If replacing file
    let newStoragePath = row.storage_path;
    let newFilename = row.filename;
    let newSize = row.size;

    if (editingNewFile) {
      const newPath = `${Date.now()}_${sanitizeFileName(editingNewFile.name)}`;
      const { error: upError } = await supabase.storage.from("symbols").upload(newPath, editingNewFile, { contentType: "application/json" });
      if (upError) throw upError;

      // delete old storage file
      await supabase.storage.from("symbols").remove([row.storage_path]).catch(()=>{});

      newStoragePath = newPath;
      newFilename = editingNewFile.name;
      newSize = editingNewFile.size;
    }

    // update DB row
    const { error: updError } = await supabase.from("symbols")
      .update({ name: newName, filename: newFilename, size: newSize, storage_path: newStoragePath })
      .eq("id", editingSymbolId);

    if (updError) throw updError;

    await loadSymbols();
    closeEditModal();
    alert("Updated successfully.");
  } catch (err) {
    console.error(err);
    alert("Update failed: " + (err.message || JSON.stringify(err)));
  }
});

/* ======= Utilities ======= */
function sanitizeFileName(name) {
  return name.replace(/[^a-zA-Z0-9._-]/g, "_");
}
function formatFileSize(bytes) {
  if (!bytes || bytes <= 0) return "0 Bytes";
  if (bytes < 1024) return `${bytes} Bytes`;
  if (bytes < 1048576) return `${(bytes/1024).toFixed(2)} KB`;
  return `${(bytes/1048576).toFixed(2)} MB`;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[c])); }

/* ======= initial load ======= */
loadSymbols();

/* ======= Helpful note: disable admin controls for non-admins by hiding upload section buttons in UI if not admin (already handled) ======= */
</script>
</body>
</html>
